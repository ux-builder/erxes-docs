import { HeroPattern } from '@/components/HeroPattern'

<HeroPattern />

export const metadata = {
  title: 'Integration í”ŒëŸ¬ê·¸ì¸ ìƒì„±',
  description:
    'ì´ ê°€ì´ë“œëŠ” Protocol APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì •í•˜ê³  ì²« ë²ˆì§¸ API ìš”ì²­ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.',
}

# Integration í”ŒëŸ¬ê·¸ì¸ ìƒì„±

Integrationì€ Inbox í”ŒëŸ¬ê·¸ì¸ì˜ í™•ì¥ìœ¼ë¡œ, íƒ€ì‚¬ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ê³µìœ  Inboxì— í†µí•©í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

<Caution>
ì§„í–‰í•˜ê¸° ì „ì—, [ê°€ì´ë“œë¼ì¸](/sdks/creategen)ì„ ì½ì–´ë³´ì‹œê³ , [ë§ˆì¼“í”Œë ˆì´ìŠ¤](https://erxes.io/marketplace)<script src='https://cdn.jsdelivr.net/gh/eddymens/markdown-external-link-script@v2.0.0/main.min.js'></script>ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ì¡´ì˜ í†µí•© ì˜ˆì œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”. ì˜ˆì œë¡œ ì‚¬ìš©í•  IMAP í†µí•©ì€ [ì—¬ê¸°](https://github.com/erxes/erxes-community/tree/dev/packages)<script src='https://cdn.jsdelivr.net/gh/eddymens/markdown-external-link-script@v2.0.0/main.min.js'></script>ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</Caution>

ì´ë¯¸ ìœ„ ê°€ì´ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í”ŒëŸ¬ê·¸ì¸ì„ ìƒì„±í–ˆë‹¤ê³  ê°€ì •í•˜ê³ , í”ŒëŸ¬ê·¸ì¸ ì´ë¦„ì€ IMAPì…ë‹ˆë‹¤.

configs.jsonì— ë‹¤ìŒ Inbox ê´€ë ¨ í”ŒëŸ¬ê·¸ì¸ì„ ì¶”ê°€í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•˜ì„¸ìš”.

```tsx
 "plugins": [
        {
            "name": "forms",
            "ui": "remote"
        },
        {
            "name": "contacts",
            "ui": "local"
        },
        {
            "name": "inbox",
            "ui": "local"
        },
        {
            "name": "imap",
            "ui": "local"
        }
```

# Inbox í†µí•©ì˜ í•µì‹¬ ê°œë…
1. **Brand** - ë°ì´í„° ë¶„ë¦¬ì˜ ê°€ì¥ í° ìˆ˜ì¤€. íšŒì‚¬ê°€ 3ê°œì˜ ìíšŒì‚¬ë¥¼ í¬í•¨í•˜ëŠ” ê·¸ë£¹ íšŒì‚¬ë¼ê³  ê°€ì •í•´ë´…ì‹œë‹¤. ì´ ê²½ìš° ê° ë¸Œëœë“œëŠ” ê° ìíšŒì‚¬ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
2. **Channel** - í†µí•© ë° íŒ€ ë©¤ë²„ ê·¸ë£¹ìœ¼ë¡œ, ëˆ„ê°€ ì–´ë–¤ í†µí•©ì„ ë‹´ë‹¹í•˜ëŠ”ì§€ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
3. **Integration** - IMAPì˜ ê²½ìš°, ì´ë©”ì¼ ì£¼ì†Œ, ë¹„ë°€ë²ˆí˜¸, smtp í˜¸ìŠ¤íŠ¸ ë“±ì„ í¬í•¨í•˜ëŠ” ì„¤ì • ì§‘í•©ì…ë‹ˆë‹¤.
4. **Customer** - IMAPì˜ ê²½ìš°, ì´ë©”ì¼ì„ ë³´ë‚¸ ì‚¬ëŒì…ë‹ˆë‹¤.
5. **Conversation** - IMAPì˜ ê²½ìš°, ì „ì²´ ì´ë©”ì¼ ìŠ¤ë ˆë“œì…ë‹ˆë‹¤.
6. **Conversation Messages** - IMAPì˜ ê²½ìš°, ë‹¨ì¼ ì´ë©”ì¼ ìŠ¤ë ˆë“œì˜ ê° ì´ë©”ì¼ í•­ëª©ì…ë‹ˆë‹¤.

# í†µí•©ì˜ ìƒëª… ì£¼ê¸°
1. í•´ë‹¹ ì„¤ì •ì„ ì‚¬ìš©í•˜ì—¬ í†µí•© ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ inboxì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤. ì´í›„ ì›í•˜ëŠ” APIì™€ ì‘ì—…í•  ë•Œ ì´ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
2. plugin-"integration-name"-apiì—ì„œ í†µí•© ì„¤ì •ì„ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” APIë¡œë¶€í„° ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
3. ìˆ˜ì‹ ëœ ë°ì´í„°ë¥¼ ëŒ€í™”, ëŒ€í™” ë©”ì‹œì§€, ê³ ê°ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. ëŒ€í™”ëŠ” inboxì˜ ë°ì´í„°ë² ì´ìŠ¤ì—, ê³ ê°ì€ contactsì˜ ë°ì´í„°ë² ì´ìŠ¤ì—, ëŒ€í™” ë©”ì‹œì§€ëŠ” í”ŒëŸ¬ê·¸ì¸ì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
4. ëŒ€í™”ì™€ ê³ ê°ì„ ì €ì¥í•˜ë©´ inboxì˜ ì‚¬ì´ë“œë°”ì— í‘œì‹œë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ëŒ€í™”ì˜ ì„¸ë¶€ ì‚¬í•­ì€ í”ŒëŸ¬ê·¸ì¸ì˜ UIì—ì„œ ë‹´ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤.
5. ëŒ€í™” ì„¸ë¶€ ì‚¬í•­ì„ í‘œì‹œí•  ìˆ˜ ìˆëŠ” ë§Œí¼, ê³ ê°ì—ê²Œ ì‘ë‹µì„ ë³´ë‚´ëŠ” ë“±ì˜ ì¶”ê°€ ì‘ì—…ë„ ë‹´ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤.

# IMAPì„ ì˜ˆë¡œ ë“¤ì–´ ìœ„ ë‹¨ê³„ë¥¼ ì‹œì—°í•´ ë³´ê² ìŠµë‹ˆë‹¤
## í†µí•© ìƒì„±
plugin-imap-uiì˜ configs.jsë¥¼ ì‚´í´ë´…ì‹œë‹¤

```tsx
 inboxIntegration: {
    name: 'IMAP',
    description:
      'Connect a company email address such as sales@mycompany.com or info@mycompany.com',
    isAvailable: true,
    kind: 'imap',
    logo: '/images/integrations/email.png',
    createModal: 'imap',
    createUrl: '/settings/integrations/imap',
    category:
      'All integrations, For support teams, Marketing automation, Email marketing'
  }
  ```
/settings/integrations ìœ„ì¹˜ì— ë‹¤ìŒ ë¸”ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.

![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/5e5d8967-e17a-45ac-5bac-f25fe6351300/public)


  ```tsx
  "./inboxIntegrationForm": "./src/components/IntegrationForm.tsx",
  ```
  and

  ```tsx
inboxIntegrationForm: './inboxIntegrationForm',
  ```

ìœ„ ê·¸ë¦¼ì—ì„œ add ë§í¬ë¥¼ í´ë¦­í•˜ë©´ `./src/components/IntegrationForm.tsx` ì»´í¬ë„ŒíŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.

![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/e4ed1a7b-874c-4b1a-201b-ce0c7a14e300/public)

"Save" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë©”ì‹œì§€ê°€ `plugin-imap-api`ë¡œ ì „ì†¡ë©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ì†Œë¹„ìë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

```tsx
consumeRPCQueue(
  'imap:createIntegration',
  async ({ subdomain, data: { doc, integrationId } }) => {
    const models = await generateModels(subdomain);

    const integration = await models.Integrations.create({
      inboxId: integrationId,
      ...doc
    });

    await listenIntegration(subdomain, integration);

    await models.Logs.createLog({
      type: 'info',
      message: `Started syncing ${integration.user}`
    });

    return {
      status: 'success'
    };
  }
);
```
[ì—¬ê¸°ì— ì˜ˆì œê°€ ìˆìŠµë‹ˆë‹¤](https://github.com/erxes/erxes-community/blob/dev/packages/plugin-imap-api/src/messageBroker.ts)<script src='https://cdn.jsdelivr.net/gh/eddymens/markdown-external-link-script@v2.0.0/main.min.js'></script>
## ì›í•˜ëŠ” APIì—ì„œ ë°ì´í„° ìˆ˜ì‹ 

[ì½”ë“œ ì˜ˆì œëŠ” ì—¬ê¸°ì— ìˆìŠµë‹ˆë‹¤](https://github.com/erxes/erxes-community/blob/dev/packages/plugin-imap-api/src/utils.ts)<script src='https://cdn.jsdelivr.net/gh/eddymens/markdown-external-link-script@v2.0.0/main.min.js'></script>

## ë°ì´í„° ì €ì¥
1. 
```tsx
const apiCustomerResponse = await sendContactsMessage({
  subdomain,
  action: 'customers.createCustomer',
  data: {
    integrationId: integration.inboxId,
    primaryEmail: from
  },
  isRPC: true
});
```
createCustomer ë©”ì‹œì§€ë¥¼ contacts í”ŒëŸ¬ê·¸ì¸ì— ë³´ë‚´ë©´ contacts í”ŒëŸ¬ê·¸ì¸ì´ ì´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤.

2. 
```tsx
const { _id } = await sendInboxMessage({
  subdomain,
  action: 'integrations.receive',
  data: {
    action: 'create-or-update-conversation',
    payload: JSON.stringify({
      integrationId: integration.inboxId,
      customerId,
      createdAt: msg.date,
      content: msg.subject
    })
  },
  isRPC: true
});
```
create ë˜ëŠ” update conversation ë©”ì‹œì§€ë¥¼ inbox í”ŒëŸ¬ê·¸ì¸ì— ë³´ë‚´ë©´ inbox í”ŒëŸ¬ê·¸ì¸ì´ ì´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤.

## ëŒ€í™” ì„¸ë¶€ ì‚¬í•­
plugin-imap-uiì˜ configs.jsì—ì„œ

```tsx
"./inboxConversationDetail": "./src/components/ConversationDetail.tsx",
```

and

```tsx
inboxConversationDetail: './inboxConversationDetail',
```

ëŒ€í™” ì„¸ë¶€ ì‚¬í•­ ì„¹ì…˜ì—ì„œ `./src/components/ConversationDetail.tsx` ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/3cd9edd4-bf11-412a-d4c4-c89127a33000/public)

# ìƒˆë¡œìš´ í†µí•© í”ŒëŸ¬ê·¸ì¸ ìƒì„±
ê° í”ŒëŸ¬ê·¸ì¸ì€ `API`ì™€ `UI`ì˜ ë‘ ë¶€ë¶„ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

1. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‘ ë¶€ë¶„ì— ëŒ€í•œ ìƒˆ í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```tsx
cd erxes
yarn create-plugin
```

ìœ„ ëª…ë ¹ì–´ëŠ” CLIë¥¼ ì‹œì‘í•˜ì—¬ ìƒˆ í†µí•© í”ŒëŸ¬ê·¸ì¸ì„ ìƒì„±í•˜ê¸° ìœ„í•œ ëª‡ ê°€ì§€ ì§ˆë¬¸ì„ ë¬»ìŠµë‹ˆë‹¤. ì´ ì˜ˆì œì—ì„œëŠ” twitter í†µí•©ì„ ìƒì„±í•©ë‹ˆë‹¤.
![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/95a9c88c-1c84-4f08-ce28-75170897fc00/public)

ì•„ë˜ ì˜ˆì œëŠ” ì˜ˆì œ í…œí”Œë¦¿ì—ì„œ ìƒì„±ëœ ìƒˆë¡œìš´ í†µí•© í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ, ì„¤ì • í†µí•©ì— ë°°ì¹˜ë©ë‹ˆë‹¤.
![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/add9ac3a-0d02-44e6-a9c6-5a1a0ae3fb00/public)

ì•„ë˜ ì˜ˆì œëŠ” ì˜ˆì œ í…œí”Œë¦¿ì—ì„œ ìƒì„±ëœ ìƒˆë¡œìš´ í†µí•© í”ŒëŸ¬ê·¸ì¸ì˜ êµ¬ì„±ìœ¼ë¡œ, ì„¤ì • í†µí•© êµ¬ì„±ì— ë°°ì¹˜ë©ë‹ˆë‹¤.
![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/08761770-ac2e-4ce2-cddf-dfdfef8daa00/public)

ì•„ë˜ ì˜ˆì œëŠ” í¼ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì˜ˆì œ í†µí•©ì„ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/23337484-540c-4cdc-cbb5-ce25ce22f300/public)

ì•„ë˜ ì˜ˆì œëŠ” ì„¸ë¶€ í˜ì´ì§€ì™€ í•¨ê»˜ ìƒˆë¡œìš´ í†µí•©ì„ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. í†µí•© í”ŒëŸ¬ê·¸ì¸ UI í…œí”Œë¦¿ì—ì„œ **with detail** ì˜µì…˜ì„ ì„ íƒí•˜ë©´ ì¶”ê°€ ë²„íŠ¼ì„ í´ë¦­í•  ë•Œ ì„¸ë¶€ í˜ì´ì§€ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
![](https://imagedelivery.net/5m26Aj-CutMXPPNacMs_yQ/9c4e7e6a-cac5-49c4-d2c8-4c0aa1925500/public)

## API íŒŒì¼ êµ¬ì¡°
í†µí•© í”ŒëŸ¬ê·¸ì¸ì„ ìƒì„±í•œ í›„, í†µí•© í”ŒëŸ¬ê·¸ì¸ APIì— ë‹¤ìŒ íŒŒì¼ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

```tsx
ğŸ“¦plugin-twitter-api
 â”£ ğŸ“‚src
 â”ƒ â”£ ğŸ“‚graphql
 â”ƒ â”ƒ â”£ ğŸ“‚resolvers
 â”ƒ â”ƒ â”ƒ â”£ index.ts
 â”ƒ â”ƒ â”ƒ â”£ mutations.ts
 â”ƒ â”ƒ â”ƒ â”— queries.ts
 â”ƒ â”ƒ â”£ index.ts
 â”ƒ â”ƒ â”— typeDefs.ts
 â”ƒ â”£ configs.ts
 â”ƒ â”£ controller.ts
 â”ƒ â”£ messageBroker.ts
 â”ƒ â”— models.ts
 â”£ .env.sample
 â”£ package.json
 â”— tsconfig.json
 ```

## ì£¼ìš” íŒŒì¼
ë‹¤ìŒ íŒŒì¼ë“¤ì´ plugin-[pluginName]-api/srcì— ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

## configs.ts
ì´ íŒŒì¼ì—ëŠ” í†µí•© í”ŒëŸ¬ê·¸ì¸ì˜ ì£¼ìš” ì„¤ì •ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```bash {{ title: 'configs.ts file:' }}
// path: ./packages/plugin-[pluginName]-api/src/configs.ts 
  import typeDefs from './graphql/typeDefs';
  import resolvers from './graphql/resolvers';
  import { initBroker } from './messageBroker';
  import init from './controller';
  export let mainDb;
  export let graphqlPubsub;
  export let serviceDiscovery;
  export let debug;
  export default {
    name: 'twitter',
    graphql: sd => {
      serviceDiscovery = sd;
      return {
        typeDefs,
        resolvers
      };
    },
    meta: {
      // this code will show the integration in UI settings -> integrations
      inboxIntegration: {
        kind: 'twitter',
        label: 'Twitter'
      }
    },
    apolloServerContext: async (context) => {
      return context;
    },
    onServerInit: async options => {
      const app = options.app;
      mainDb = options.db;
      debug = options.debug;
      graphqlPubsub = options.pubsubClient;
      initBroker(options.messageBrokerClient);
      // integration controller
      init(app);
    }
  };
  ```
## controller.ts
ì´ íŒŒì¼ì—ëŠ” í†µí•©ì„ ë“£ê³ , erxesì™€ ì—°ê²°í•˜ê³  ëŒ€í™”ì™€ ê³ ê°ì„ ìƒì„±í•˜ëŠ” í†µí•© ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ ì˜ˆì œì—ì„œëŠ” ë©”ì‹œì§€ ì €ì¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
```bash {{ title: 'controller.ts file:' }}
import { sendContactsMessage, sendInboxMessage } from './messageBroker';
  import { Customers, Messages } from './models';
  // util function
  const searchMessages = (linkedin, criteria) => {
    return new Promise((resolve, reject) => {
      const messages: any = [];
    });
  };
  // ì˜ˆì œ: ë©”ì‹œì§€ë¥¼ inboxì— ì €ì¥í•˜ê³  ê³ ê°ì„ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸í•˜ëŠ” ì˜ˆì œ
  const saveMessages = async (
    linkedin,
    integration,
    criteria
  ) => {
    const msgs: any = await searchMessages(linkedin, criteria);
    for (const msg of msgs) {
      const message = await Messages.findOne({
        messageId: msg.messageId
      });
      if (message) {
        continue;
      }
      const from = msg.from.value[0].address;
      const prev = await Customers.findOne({ email: from });
      let customerId;
      if (!prev) {
        // search customer from contacts api
        const customer = await sendContactsMessage({
          subdomain: 'os',
          action: 'customers.findOne',
          data: {
            primaryEmail: from
          },
          isRPC: true
        });
        if (customer) {
          customerId = customer._id;
        } else {
          // creating new customer
          const apiCustomerResponse = await sendContactsMessage({
            subdomain: 'os',
            action: 'customers.createCustomer',
            data: {
              integrationId: integration.inboxId,
              primaryEmail: from
            },
            isRPC: true
          });
          customerId = apiCustomerResponse._id;
        }
        await Customers.create({
          inboxIntegrationId: integration.inboxId,
          contactsId: customerId,
          email: from
        });
      } else {
        customerId = prev.contactsId;
      }
      let conversationId;
      const relatedMessage = await Messages.findOne({
        $or: [
          { messageId: msg.inReplyTo },
          { messageId: { $in: msg.references || [] } },
          { references: { $in: [msg.messageId] } },
          { references: { $in: [msg.inReplyTo] } }
        ]
      });
      if (relatedMessage) {
        conversationId = relatedMessage.inboxConversationId;
      } else {
        const { _id } = await sendInboxMessage({
          subdomain: 'os',
          action: 'integrations.receive',
          data: {
            action: 'create-or-update-conversation',
            payload: JSON.stringify({
              integrationId: integration.inboxId,
              customerId,
              createdAt: msg.date,
              content: msg.subject
            })
          },
          isRPC: true
        });
        conversationId = _id;
      }
      await Messages.create({
        inboxIntegrationId: integration.inboxId,
        inboxConversationId: conversationId,
        createdAt: msg.date,
        messageId: msg.messageId,
        inReplyTo: msg.inReplyTo,
        references: msg.references,
        subject: msg.subject,
        body: msg.html,
        to: msg.to && msg.to.value,
        cc: msg.cc && msg.cc.value,
        bcc: msg.bcc && msg.bcc.value,
        from: msg.from && msg.from.value,
      });
    }
  };
  // twitterì— ëŒ€í•œ controller
  const init = async app => {
    // write integration login method below
    app.get('/login', async (req, res) => {
      res.send("login")
    });
    
    app.post('/receive', async (req, res, next) => {
      try {
        // write receive message from integration code here
        res.send("Successfully receiving message");
      } catch (e) {
        return next(new Error(e));
      }
      res.sendStatus(200);
    });
  };
  export default init;
  ```

## messageBroker.ts
ì´ íŒŒì¼ì€ ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸ê³¼ ì—°ê²°í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. [ê³µí†µ ê¸°ëŠ¥](#)ì—ì„œ ë©”ì‹œì§€ ë¸Œë¡œì»¤ ê¸°ëŠ¥ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash {{ title: 'messageBroker.ts file:' }}
// path: ./packages/plugin-[pluginName]-api/src/messageBroker.ts 
  import * as dotenv from 'dotenv';
  import {
    ISendMessageArgs,
    sendMessage as sendCommonMessage
  } from '@erxes/api-utils/src/core';
  import { serviceDiscovery } from './configs';
  import { Customers, Integrations, Messages } from './models';
  dotenv.config();
  let client;
  export const initBroker = async cl => {
    client = cl;
    const { consumeRPCQueue } = client;
    consumeRPCQueue(
      'twitter:createIntegration',
      async ({ data: { doc, integrationId } }) => {
        await Integrations.create({
          inboxId: integrationId,
          ...(doc || {})
        });
        return {
          status: 'success'
        };
      }
    );
    consumeRPCQueue(
      'twitter:removeIntegration',
      async ({ data: { integrationId } }) => {
        await Messages.remove({ inboxIntegrationId: integrationId });
        await Customers.remove({ inboxIntegrationId: integrationId });
        await Integrations.remove({ inboxId: integrationId });
        return {
          status: 'success'
        };
      }
    );
  };
  export default function() {
    return client;
  }
  export const sendContactsMessage = (args: ISendMessageArgs) => {
    return sendCommonMessage({
      client,
      serviceDiscovery,
      serviceName: 'contacts',
      ...args
    });
  };
  export const sendInboxMessage = (args: ISendMessageArgs) => {
    return sendCommonMessage({
      client,
      serviceDiscovery,
      serviceName: 'inbox',
      ...args
    });
  };
  ```
  
## GraphQL ê°œë°œ
`packages/plugin-<new_plugin>-api/src` ë‚´ë¶€ì— `graphql` í´ë”ê°€ ìˆìŠµë‹ˆë‹¤. ì´ í´ë”ì—ëŠ” GraphQLê³¼ ê´€ë ¨ëœ ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```tsx
 ğŸ“‚src
 â”£ ğŸ“‚graphql
 â”ƒ â”£ ğŸ“‚resolvers 
 â”ƒ â”ƒ â”£ index.ts
 â”ƒ â”ƒ â”£ mutations.ts
 â”ƒ â”ƒ â”— queries.ts
 â”ƒ â”£ index.ts
 â”ƒ â”— typeDefs.ts
 ```



## GraphQL resolvers
`/graphql/resolvers/mutations` í´ë” ë‚´ì— GraphQL mutation ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```bash {{ title: 'mutation examples:' }}
  import { Accounts } from '../../models';
  import { IContext } from "@erxes/api-utils/src/types"
  const twitterMutations = {
    async twitterAccountRemove(_root, {_id}: {_id: string}, _context: IContext) {
      await Accounts.removeAccount(_id);
      return 'deleted';
    }
  };
  export default twitterMutations;
  ```

`/graphql/resolvers/queries` í´ë” ë‚´ì— GraphQL query ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```bash {{ title: 'query examples:' }}
  import { IContext } from '@erxes/api-utils/src/types';
  import { Accounts, Messages } from '../../models';
  const queries = {
    async twitterConversationDetail(
      _root,
      { conversationId },
      _context: IContext
    ) {
      const messages = await Messages.find({
        inboxConversationId: conversationId
      });
      const convertEmails = emails =>
        (emails || []).map(item => ({ name: item.name, email: item.address }));
      return messages.map(message => {
        return {
          _id: message._id,
          mailData: {
            messageId: message.messageId,
            from: convertEmails(message.from),
            to: convertEmails(message.to),
            cc: convertEmails(message.cc),
            bcc: convertEmails(message.bcc),
            subject: message.subject,
            body: message.body,
          }
        };
      });
    },
    async twitterAccounts(_root, _args, _context: IContext) {
      return Accounts.getAccounts();
    }
  };
  export default queries;
  ```

## GraphQL typeDefs
`/graphql/typeDefs.ts` íŒŒì¼ ë‚´ì— GraphQL typeDefsê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```bash {{ title: 'typeDefs:' }}
import { gql } from 'apollo-server-express';
  const types = `
    type Twitter {
      _id: String!
      title: String
      mailData: JSON
    }
  `;
  const queries = `
    twitterConversationDetail(conversationId: String!): [Twitter]
    twitterAccounts: JSON
  `;
  const mutations = `
    twitterAccountRemove(_id: String!): String
  `;
  const typeDefs = gql`
    scalar JSON
    scalar Date
    ${types}
    extend type Query {
      ${queries}
    }
    extend type Mutation {
      ${mutations}
    }
  `;
  export default typeDefs;
  ```

## Database ê°œë°œ
`packages/plugin-<new_plugin>-api/src` ë‚´ë¶€ì— `models` íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” MongoDBì™€ mongoose ê´€ë ¨ ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```tsx
ğŸ“‚src
â”— models.ts
```
## Mongoose ìŠ¤í‚¤ë§ˆ ë° ëª¨ë¸
`src/models.ts` íŒŒì¼ ë‚´ì— Mongoose ìŠ¤í‚¤ë§ˆ ë° ëª¨ë¸ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
```bash {{ title: 'Mongoose schema and model example:' }}
1
```

## UI íŒŒì¼ êµ¬ì¡°
ìë™ìœ¼ë¡œ ìƒì„±ëœ í†µí•© í”ŒëŸ¬ê·¸ì¸ UIì˜ íŒŒì¼ êµ¬ì¡°ëŠ” ì¼ë°˜ í”ŒëŸ¬ê·¸ì¸ê³¼ ë™ì¼í•©ë‹ˆë‹¤. ìœ ì¼í•œ ì°¨ì´ì ì€ UI êµ¬ì„±ì…ë‹ˆë‹¤. ì¼ë°˜ í”ŒëŸ¬ê·¸ì¸ UI íŒŒì¼ êµ¬ì¡°ë¥¼ ë³´ë ¤ë©´ [ì—¬ê¸°](#)ë¥¼ í´ë¦­í•˜ì„¸ìš”.

# UI êµ¬ì„±

## í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ í¬íŠ¸
`packages/plugin-<new_plugin>-ui/src/configs.js` ë‚´ë¶€ì— í”ŒëŸ¬ê·¸ì¸ UIì˜ ì‹¤í–‰ í¬íŠ¸ê°€ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì€ 3024ì…ë‹ˆë‹¤. ê° í”ŒëŸ¬ê·¸ì¸ì€ ê³ ìœ í•œ í¬íŠ¸ì—ì„œ UIë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ëŸ¬ í”ŒëŸ¬ê·¸ì¸ì„ ê°œë°œí•˜ëŠ” ê²½ìš° í¬íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤(`configs.js` ë‚´ë¶€).

```tsx
module.exports = {
  name: 'twitter',
  scope: 'twitter',
  port: 3024,
  exposes: {
    './routes': './src/routes.tsx',

    // ì•„ë˜ ì»´í¬ë„ŒíŠ¸ëŠ” ë™ì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤. ì´ ê²½ìš°, inbox-uiì—ì„œ ì´ ì»´í¬ë„ŒíŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
    './inboxIntegrationSettings': './src/components/IntegrationSettings.tsx',
    './inboxIntegrationForm': './src/components/IntegrationForm.tsx',
    './inboxConversationDetail': './src/components/ConversationDetail.tsx'

  },
  routes: {
    url: 'http://localhost:3024/remoteEntry.js',
    scope: 'twitter',
    module: './routes'
  },

  // ë…¸ì¶œëœ ì»´í¬ë„ŒíŠ¸ í˜¸ì¶œ
  inboxIntegrationSettings: './inboxIntegrationSettings',
  inboxIntegrationForm: './inboxIntegrationForm',
  inboxConversationDetail: './inboxConversationDetail',

  inboxIntegration: {
    name: 'Twitter',

    // í†µí•© ì„¤ëª…ì´ í†µí•© ìƒìì— í‘œì‹œë©ë‹ˆë‹¤.
    description:
      'Please write integration description on plugin config file',
    
    // ì´ ë³€ìˆ˜ëŠ” í†µí•©ì´ í”„ë¡œë•ì…˜ ëª¨ë“œì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•¨ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ê°œë°œ ëª¨ë“œì—ì„œëŠ” í•­ìƒ true ê°’ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    isAvailable: true,

    // í†µí•© ìœ í˜•ì€ ë™ì ìœ¼ë¡œ í†µí•© ì–‘ì‹ì„ í˜¸ì¶œí•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤. 
    kind: 'twitter',

    // í†µí•© ë¡œê³ 
    logo: '/images/integrations/twitter.png',
    
    // CLIë¥¼ ì‚¬ìš©í•˜ì—¬ í†µí•© í”ŒëŸ¬ê·¸ì¸ì„ ìƒì„±í•  ë•Œ ìƒì„¸ í˜ì´ì§€ë¥¼ ì„ íƒí•œ ê²½ìš°, í†µí•© ìƒìì—ì„œ ì¶”ê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í†µí•©ì´ ì´ URLë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
    createUrl: '/settings/integrations/twitter',
  }
};
```
// ë™ì  ì»´í¬ë„ŒíŠ¸ í”ŒëŸ¬ê·¸ì¸ í˜¸ì¶œ
í”ŒëŸ¬ê·¸ì¸ inbox UIì—ì„œ ë™ì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ìˆëŠ” íŒŒì¼.

**inboxIntegrationSettings.tsx ì»´í¬ë„ŒíŠ¸**
`packages/plugin-inbox-ui/src/settings/integrationsConfig/components/IntegrationConfigs.tsx` ë‚´ë¶€ì— `loadDynamicComponent` í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì½”ë“œëŠ” plugin inbox UIì—ì„œ integrationConfigs ì»´í¬ë„ŒíŠ¸ë¥¼ ë™ì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

```tsx
{loadDynamicComponent(
    'inboxIntegrationSettings',
    {
      renderItem: this.renderItem
    },
    true
  )}
```

**inboxIntegrationForm.tsx ì»´í¬ë„ŒíŠ¸**
`packages/plugin-inbox-ui/src/settings/integrations/containers/common/IntegrationForm.tsx` ë‚´ë¶€ì— `loadDynamicComponent` í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì½”ë“œëŠ” plugin inbox UIì—ì„œ integrationForm ì»´í¬ë„ŒíŠ¸ë¥¼ ë™ì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

```tsx
return loadDynamicComponent(
  'inboxIntegrationForm',
  updatedProps,
  false,
  type
);
```

**inboxConversationDetail.tsx ì»´í¬ë„ŒíŠ¸**
`packages/plugin-inbox-ui/src/inbox/components/conversationDetail/workarea/WorkArea.tsx` ë‚´ë¶€ì— `loadDynamicComponent` í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì½”ë“œëŠ” plugin inbox UIì—ì„œ inboxConversationDetail ì»´í¬ë„ŒíŠ¸ë¥¼ ë™ì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

```tsx
content = loadDynamicComponent('inboxConversationDetail', {
  ...this.props
});
```

## í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”
`cli/configs.json`ì˜ "plugins" ì„¹ì…˜ì—ëŠ” erxesê°€ ì‹œì‘ë  ë•Œ ì‹¤í–‰ë˜ëŠ” í”ŒëŸ¬ê·¸ì¸ ì´ë¦„ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸ì„ í™œì„±í™”í•˜ê±°ë‚˜ ì œê±°í•˜ê±°ë‚˜ ë‹¤ì‹œ ìƒì„±í•˜ë ¤ëŠ” ê²½ìš° ì´ ì„¹ì…˜ì„ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
```tsx
{
 "jwt_token_secret": "token",
 "dashboard": {},
 "client_portal_domains": "",
 "elasticsearch": {},
 "redis": {
   "password": ""
 },
 "mongo": {
   "username": "",
   "password": ""
 },
 "rabbitmq": {
   "cookie": "",
   "user": "",
   "pass": "",
   "vhost": ""
 },
 "plugins": [
   {
     "name": "logs"
   },
   {
     "name": "new_plugin",
     "ui": "local"
   }
 ]
}
```

# erxes ì‹¤í–‰
`create-plugin` ëª…ë ¹ì€ `cli/configs.json`ì— ìƒˆë¡œìš´ ì¤„ì„ ìë™ìœ¼ë¡œ ì¶”ê°€í•˜ê³  í•„ìš”í•œ ì¢…ì†ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```tsx
{
    "jwt_token_secret": "token",
    "client_portal_domains": "",
    "elasticsearch": {},
    "redis": {
        "password": "pass"
    },
    "mongo": {
        "username": "",
        "password": ""
    },
    "rabbitmq": {
        "cookie": "",
        "user": "",
        "pass": "",
        "vhost": ""
    },
    "plugins": [
        {
            "name": "forms",
            "ui": "remote"
        },
        {
            "name": "contacts",
            "ui": "local"
        },
        {
            "name": "inbox",
            "ui": "local"
        },
        {
            "name": "twitter",
            "ui": "local"
        },
    ]
}
```
2. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
```tsx
cd erxes/cli
yarn install
```

3. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ìƒˆë¡œ ì„¤ì¹˜ëœ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ erxesë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
```tsx
./bin/erxes.js dev
```